<!DOCTYPE html>
<!-- lang="zh-Hant" ä»£è¡¨é€™æ˜¯ä¸€å€‹ç¹é«”ä¸­æ–‡çš„ç¶²é  -->
<html lang="zh-Hant">
<head>
    <!-- å®£å‘Šæ–‡ä»¶ä½¿ç”¨çš„å­—å…ƒç·¨ç¢¼æ˜¯ UTF-8ï¼Œé¿å…äº‚ç¢¼ -->
    <meta charset="UTF-8" />
    <!-- é€™æ˜¯éŸ¿æ‡‰å¼ç¶²é è¨­è¨ˆçš„é—œéµè¨­å®šï¼Œè®“ç¶²é åœ¨æ‰‹æ©Ÿå’Œé›»è…¦ä¸Šéƒ½èƒ½æœ‰å¥½çš„é¡¯ç¤ºæ•ˆæœ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- é¡¯ç¤ºåœ¨ç€è¦½å™¨åˆ†é æ¨™ç±¤ä¸Šçš„æ¨™é¡Œ -->
    <title>AI æ¨¡å‹è™•ç†ä»‹é¢</title>
    
    <!-- è¼‰å…¥ Tailwind CSS å‡½å¼åº« -->
    <!-- Tailwind æ˜¯ä¸€å€‹ CSS æ¡†æ¶ï¼Œè®“æˆ‘å€‘å¯ä»¥ç”¨ class çš„æ–¹å¼å¿«é€Ÿè¨­å®šæ¨£å¼ï¼Œä¾‹å¦‚ class="text-2xl font-bold" -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- === React æ ¸å¿ƒå‡½å¼åº« === -->
    <!-- 1. è¼‰å…¥ React æ ¸å¿ƒ -->
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <!-- 2. è¼‰å…¥ React DOMï¼Œé€™æ˜¯ React ç”¨ä¾†æ“ä½œç¶²é å…ƒç´ çš„å·¥å…· -->
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <!-- 3. è¼‰å…¥ Babel -->
    <!-- ç€è¦½å™¨æœ¬èº«ä¸èªè­˜ React çš„ JSX èªæ³• (çœ‹èµ·ä¾†åƒ HTML çš„èªæ³•)ï¼ŒBabel çš„ä½œç”¨å°±æ˜¯å³æ™‚å°‡ JSX è½‰è­¯æˆç€è¦½å™¨çœ‹å¾—æ‡‚çš„æ™®é€š JavaScript -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è‡ªè¨‚çš„ CSS æ¨£å¼ -->
    <style>
        /* è¨­å®šç¶²é é è¨­å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* å®šç¾©èŠå¤©æ°£æ³¡çš„æ¨£å¼ */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word; /* è®“é•·å–®å­—å¯ä»¥è‡ªå‹•æ›è¡Œ */
        }
        /* ä½¿ç”¨è€…ç™¼é€çš„æ°£æ³¡æ¨£å¼ (ç¶ è‰²ï¼Œé å³) */
        .chat-bubble.user {
            background-color: #d1fae5; /* green-200 */
            align-self: flex-end;
        }
        /* AI Server å›æ‡‰çš„æ°£æ³¡æ¨£å¼ (ç°è‰²ï¼Œé å·¦) */
        .chat-bubble.bot {
            background-color: #e5e7eb; /* gray-200 */
            align-self: flex-start;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- é€™å€‹ div æ˜¯ React æ‡‰ç”¨ç¨‹å¼çš„é€²å…¥é»ã€‚React æœƒæŠŠæ‰€æœ‰å‹•æ…‹ç”¢ç”Ÿçš„ç¶²é å…§å®¹éƒ½å¡é€²é€™å€‹ div è£¡é¢ã€‚ -->
    <div id="root"></div>

    <!-- é‡è¦çš„ "type=text/babel" å‘Šè¨´ç€è¦½å™¨ï¼Œé€™æ®µ script éœ€è¦å…ˆç¶“é Babel è™•ç† -->
    <script type="text/babel">
        // å¾ React å‡½å¼åº«ä¸­å–å‡ºå¹¾å€‹å¸¸ç”¨çš„å·¥å…· (Hooks)ï¼Œæ–¹ä¾¿å¾Œé¢ç›´æ¥ä½¿ç”¨
        const { useState, useEffect, useRef } = React;

        // --- React å…ƒä»¶å®šç¾© ---
        
        /**
         * [æ–°å¢] ConnectionStatus å…ƒä»¶ï¼šé¡¯ç¤º WebSocket é€£ç·šç‹€æ…‹
         */
        function ConnectionStatus({ isConnected }) {
            const statusColor = isConnected ? 'bg-green-500' : 'bg-red-500';
            const statusText = isConnected ? 'é€£ç·šæˆåŠŸ' : 'é€£ç·šä¸­æ–·';
            return (
                <div className="flex items-center space-x-2">
                    <span className={`h-3 w-3 rounded-full ${statusColor} transition-colors duration-500`}></span>
                    <span className="text-sm font-medium text-gray-300">{statusText}</span>
                </div>
            );
        }

        /**
         * Message å…ƒä»¶ï¼šå°ˆé–€ç”¨ä¾†é¡¯ç¤ºä¸€æ¢èŠå¤©è¨Šæ¯ (æ”¯æ´æ‰¹æ¬¡çµæœ)
         */
        function Message({ message }) {
            const isBot = message.sender === 'bot';
            const bubbleClass = isBot ? 'bot' : 'user';
            const alignClass = isBot ? 'justify-start' : 'justify-end';

            return (
                <div className={`flex ${alignClass} mb-4`}>
                    <div className={`chat-bubble ${bubbleClass}`}>
                        <div className="font-bold text-sm mb-1">{isBot ? 'AI Server' : 'You'}</div>
                        <div>{message.text}</div>
                        
                        {/* å–®ä¸€åœ–ç‰‡é¡¯ç¤º (å‘å¾Œå…¼å®¹) */}
                        {message.imageUrl && !message.batch_results && (
                            <div className="mt-2">
                                <img src={message.imageUrl} alt="AI analysis result" className="rounded-lg max-w-full h-auto" />
                            </div>
                        )}
                        
                        {/* æ‰¹æ¬¡çµæœé¡¯ç¤º */}
                        {message.batch_results && (
                            <BatchResultsDisplay results={message.batch_results} />
                        )}
                        
                        {/* å–®ä¸€ GDS ä¸‹è¼‰ (å‘å¾Œå…¼å®¹) */}
                        {message.gdsUrl && !message.batch_results && (
                             <a 
                                href={message.gdsUrl} 
                                download 
                                className="mt-2 inline-block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
                            >
                                ä¸‹è¼‰ GDS æª”æ¡ˆ
                            </a>
                        )}
                        
                        {/* æ‰¹æ¬¡ä¸‹è¼‰ ZIP */}
                        {message.zip_url && (
                            <a 
                                href={message.zip_url} 
                                download 
                                className="mt-2 inline-block bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
                            >
                                ğŸ“¦ ä¸‹è¼‰å®Œæ•´æ‰¹æ¬¡ ZIP
                            </a>
                        )}
                    </div>
                </div>
            );
        }
        
        /**
         * BatchResultsDisplay å…ƒä»¶ï¼šé¡¯ç¤ºæ‰¹æ¬¡è™•ç†çµæœ
         */
        function BatchResultsDisplay({ results }) {
            const [selectedTab, setSelectedTab] = useState('images');
            
            if (!results || !results.files) return null;
            
            const pngFiles = results.files.filter(f => f.type === 'png');
            const gdsFiles = results.files.filter(f => f.type === 'gds');
            
            return (
                <div className="mt-3 border border-gray-200 rounded-lg p-3">
                    <div className="text-sm font-semibold text-gray-600 mb-2">
                        æ‰¹æ¬¡çµæœ: {results.total_count} å€‹æª”æ¡ˆ
                    </div>
                    
                    {/* Tab åˆ‡æ› */}
                    {pngFiles.length > 0 && (
                        <div className="flex space-x-2 mb-3">
                            <button
                                onClick={() => setSelectedTab('images')}
                                className={`px-3 py-1 text-xs rounded ${selectedTab === 'images' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                            >
                                åœ–ç‰‡é è¦½ ({pngFiles.length})
                            </button>
                            <button
                                onClick={() => setSelectedTab('files')}
                                className={`px-3 py-1 text-xs rounded ${selectedTab === 'files' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                            >
                                æª”æ¡ˆåˆ—è¡¨ ({gdsFiles.length})
                            </button>
                        </div>
                    )}
                    
                    {/* åœ–ç‰‡é è¦½ */}
                    {selectedTab === 'images' && pngFiles.length > 0 && (
                        <div className="grid grid-cols-2 gap-2 mb-3">
                            {pngFiles.map((file, idx) => (
                                <div key={idx} className="text-center">
                                    <img 
                                        src={file.url} 
                                        alt={file.description} 
                                        className="w-full h-20 object-cover rounded border cursor-pointer hover:opacity-80"
                                        onClick={() => window.open(file.url, '_blank')}
                                    />
                                    <div className="text-xs text-gray-500 mt-1">{file.description}</div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* æª”æ¡ˆåˆ—è¡¨ */}
                    {selectedTab === 'files' && gdsFiles.length > 0 && (
                        <div className="space-y-1 mb-3">
                            {gdsFiles.map((file, idx) => (
                                <div key={idx} className="flex justify-between items-center text-xs bg-gray-50 p-2 rounded">
                                    <span>{file.description}</span>
                                    <a 
                                        href={file.url} 
                                        download 
                                        className="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600"
                                    >
                                        ä¸‹è¼‰
                                    </a>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        /**
         * ChatWindow å…ƒä»¶ï¼šé¡¯ç¤ºæ•´å€‹èŠå¤©æ­·å²ç´€éŒ„çš„è¦–çª—
         */
        function ChatWindow({ messages }) {
            const chatEndRef = useRef(null);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            return (
                <div className="flex-1 p-6 overflow-y-auto bg-white rounded-t-lg">
                    {messages.map((msg, index) => (
                        <Message key={index} message={msg} />
                    ))}
                    <div ref={chatEndRef} />
                </div>
            );
        }

        /**
         * App å…ƒä»¶ï¼šæ•´å€‹æ‡‰ç”¨ç¨‹å¼çš„ä¸»é«”
         */
        function App() {
            const [messages, setMessages] = useState([
                { sender: 'bot', text: 'æ‚¨å¥½ï¼è«‹ä¸Šå‚³ PDF æª”æ¡ˆæˆ–è¼¸å…¥ Rule æè¿°ä¾†é–‹å§‹ä»»å‹™ã€‚' }
            ]);
            const [inputText, setInputText] = useState('');
            const [files, setFiles] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            // [æ–°å¢] ç”¨ä¾†è¿½è¹¤ WebSocket é€£ç·šç‹€æ…‹çš„ state
            const [isConnected, setIsConnected] = useState(false);
            
            const clientId = useRef(`client_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`);

            useEffect(() => {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/${clientId.current}`);
                
                ws.onopen = () => {
                    console.log(`WebSocket é€£ç·šæˆåŠŸï¼Œå®¢æˆ¶ç«¯ ID: ${clientId.current}`);
                    setIsConnected(true); // [ä¿®æ”¹] é€£ç·šæˆåŠŸæ™‚æ›´æ–°ç‹€æ…‹
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    const newMessage = {
                        sender: 'bot',
                        text: data.message,
                        // å‘å¾Œå…¼å®¹å–®ä¸€æª”æ¡ˆ
                        imageUrl: data.image_url,
                        gdsUrl: data.gds_url,
                        // æ–°å¢æ‰¹æ¬¡çµæœæ”¯æ´
                        batch_results: data.batch_results,
                        zip_url: data.zip_url
                    };
                    setMessages(prev => [...prev, newMessage]);
                    if (data.status === 'completed' || data.status === 'error') {
                        setIsLoading(false);
                    }
                };
                
                ws.onerror = (error) => {
                    console.error("WebSocket éŒ¯èª¤:", error);
                    setIsConnected(false); // [ä¿®æ”¹] é€£ç·šéŒ¯èª¤æ™‚æ›´æ–°ç‹€æ…‹
                    const errorMessage = {
                        sender: 'bot',
                        text: 'èˆ‡ä¼ºæœå™¨çš„å³æ™‚é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æœå‹™ç‹€æ…‹ä¸¦åˆ·æ–°é é¢ã€‚'
                    };
                    setMessages(prev => [...prev, errorMessage]);
                    setIsLoading(false);
                };

                // [æ–°å¢] ç›£è½é€£ç·šé—œé–‰äº‹ä»¶
                ws.onclose = () => {
                    console.log("WebSocket é€£ç·šå·²é—œé–‰");
                    setIsConnected(false); // é€£ç·šé—œé–‰æ™‚æ›´æ–°ç‹€æ…‹
                };

                return () => {
                    ws.close();
                };
            }, []);

            const handleFileChange = (e) => {
                setFiles(Array.from(e.target.files));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!inputText.trim() && files.length === 0) {
                    alert('è«‹è‡³å°‘è¼¸å…¥æ–‡å­—æˆ–é¸æ“‡ä¸€å€‹æª”æ¡ˆã€‚');
                    return;
                }
                
                setIsLoading(true);
                
                const userMessage = { 
                    sender: 'user', 
                    text: `æäº¤ä»»å‹™ï¼š${inputText} (${files.length} å€‹æª”æ¡ˆ)` 
                };
                setMessages(prev => [...prev, userMessage]);

                const formData = new FormData();
                formData.append('text', inputText);
                formData.append('client_id', clientId.current);
                files.forEach(file => {
                    formData.append('files', file);
                });

                try {
                    const response = await fetch('/submit-task', {
                        method: 'POST',
                        body: formData,
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        const botMessage = {
                            sender: 'bot',
                            text: `ä»»å‹™å·²æˆåŠŸæäº¤ (Task ID: ${result.task_id})ï¼Œè«‹ç¨å€™...`
                        };
                        setMessages(prev => [...prev, botMessage]);
                    } else {
                        throw new Error(result.detail || 'æäº¤ä»»å‹™å¤±æ•—');
                    }
                } catch (error) {
                    console.error("æäº¤å¤±æ•—:", error);
                    const errorMessage = { sender: 'bot', text: `éŒ¯èª¤ï¼š${error.message}` };
                    setMessages(prev => [...prev, errorMessage]);
                    setIsLoading(false);
                }
                
                setInputText('');
                setFiles([]);
                document.getElementById('file-input').value = '';
            };

            return (
                <div className="flex flex-col h-screen max-w-4xl mx-auto bg-gray-200 shadow-2xl rounded-lg">
                    {/* [ä¿®æ”¹] è®“ header å¯ä»¥åŒæ™‚é¡¯ç¤ºæ¨™é¡Œå’Œé€£ç·šç‹€æ…‹ */}
                    <header className="bg-gray-800 text-white p-4 flex justify-between items-center rounded-t-lg">
                        <h1 className="text-2xl font-bold">DRC æœå‹™</h1>
                        {/* [æ–°å¢] ä½¿ç”¨é€£ç·šç‹€æ…‹å…ƒä»¶ */}
                        <ConnectionStatus isConnected={isConnected} />
                    </header>
                    <ChatWindow messages={messages} />
                    <footer className="p-4 bg-white border-t border-gray-300 rounded-b-lg">
                        <form onSubmit={handleSubmit} className="flex items-center space-x-4">
                            <input
                                type="text"
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                placeholder="è¼¸å…¥ DRC Rule æè¿°..."
                                className="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                disabled={isLoading}
                            />
                            <input
                                type="file"
                                id="file-input"
                                onChange={handleFileChange}
                                multiple
                                className="hidden"
                            />
                            <label htmlFor="file-input" className={`px-4 py-2 text-white font-semibold rounded-lg cursor-pointer ${isLoading ? 'bg-gray-400' : 'bg-indigo-500 hover:bg-indigo-600'}`}>
                                {files.length > 0 ? `${files.length} å€‹æª”æ¡ˆ` : 'é¸æ“‡æª”æ¡ˆ'}
                            </label>
                            <button
                                type="submit"
                                className={`px-6 py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400`}
                                disabled={isLoading}
                            >
                                {isLoading ? 'è™•ç†ä¸­...' : 'æäº¤'}
                            </button>
                        </form>
                    </footer>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

